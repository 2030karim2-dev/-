# خطة إعادة تصميم نظام المرتجعات

## الملخص التنفيذي

سيتم إعادة تصميم نظام المرتجعات بالكامل لحل المشكلات الحالية وضمان تجربة مستخدم سلسة. سيعتمد التصميم الجديد على عرض الفاتورة الأصلية واختيار المنتجات منها مباشرة.

---

## المشاكل الحالية

1. **حقول الإدخال لا تعمل**: مشكلة في التفاعل مع حقول النماذج
2. **عدم عرض منتجات الفاتورة**: عند اختيار الفاتورة الأصلية لا تظهر قائمة المنتجات
3. **تعقيد الواجهة**: واجهة غير واضحة لصعوبة اختيار المنتجات

---

## التصميم الجديد المقترح

### 1. هيكل الواجهة الجديد

```
┌─────────────────────────────────────────────────────────────┐
│  إنشاء مرتجع جديد                                              │
├─────────────────────────────────────────────────────────────┤
│  النوع: ○ مرتجع مبيعات  ○ مرتجع مشتريات                       │
├─────────────────────────────────────────────────────────────┤
│  الفاتورة الأصلية: [حدد الفاتورة من القائمة ▼]                │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │  تفاصيل الفاتورة المختارة                              │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  رقم الفاتورة: INV-001                                │   │
│  │  التاريخ: 2026-01-15                                  │   │
│  │  العميل/المورد: شركة التجار                            │   │
│  │  الإجمالي: 1,500.00 ريال                              │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │  أصناف الفاتورة المتاحة للإرجاع                        │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  ☑ منتج أ  | الكمية: 5  | السعر: 100  | إرجاع: [2]  │   │
│  │  ☑ منتج ب  | الكمية: 3  | السعر: 200  | إرجاع: [0]  │   │
│  │  ☐ منتج ج  | الكمية: 10 | السعر: 50   | إرجاع: [ ]  │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  سبب الإرجاع: [حدد السبب ▼]                                  │
├─────────────────────────────────────────────────────────────┤
│  ملاحظات: [أضف ملاحظات...]                                  │
├─────────────────────────────────────────────────────────────┤
│  الإجمالي المرتجع: 300.00 ريال                              │
├─────────────────────────────────────────────────────────────┤
│            [إلغاء]        [تأكيد الإرجاع]                    │
└─────────────────────────────────────────────────────────────┘
```

### 2. مميزات التصميم الجديد

#### أ. اختيار الفاتورة الأصلية
- قائمة منسدلة لاختيار الفاتورة
- عرض معلومات الفاتورة المختارة بشكل واضح
- البحث في الفواتير حسب الرقم أو العميل/المورد

#### ب. عرض منتجات الفاتورة
- عرض جميع أصناف الفاتورة الأصلية
- كل صنف يُظهر:
  - اسم المنتج
  - الكمية الأصلية في الفاتورة
  - السعر الوحدوي
  - حقل إدخال للكمية المراد إرجاعها
- تحديد الكمية المسموح إرجاعها (أقل من أو تساوي الكمية الأصلية)

#### ج. إدارة الكميات المرتجعة
- التحقق التلقائي من الكمية
- منع إرجاع أكثر من الكمية الأصلية
- عرض الإجمالي实时

#### د. ربط المرتجع بالفاتورة
- تخزين مرجع الفاتورة الأصلية
- تتبع حالة الإرجاع

#### هـ. تحديث المخزون
- عند تأكيد الإرجاع:
  - إضافة الكمية المرتجعة للمخزون (مرتجع مبيعات)
  - خصم الكمية المرتجعة من المخزون (مرتجع مشتريات)

---

## الملفات المطلوبة

### ملفات جديدة
```
src/features/returns/
├── components/
│   ├── ReturnsWizard.tsx      # معالج المرتجعات الجديد
│   ├── InvoiceSelector.tsx    # مكون اختيار الفاتورة
│   ├── InvoiceItemsList.tsx   # قائمة أصناف الفاتورة
│   └── ReturnSummary.tsx      # ملخص المرتجع
├── hooks/
│   └── useReturns.ts          # خطافات مشتركة
└── types/
    └── index.ts               # الأنواع المشتركة
```

### ملفات معدلة
```
src/features/sales/pages/SalesPage.tsx
src/features/purchases/pages/PurchasesPage.tsx
```

---

## خطوات التنفيذ

### المرحلة 1: حذف الملفات القديمة
- [ ] حذف CreateReturnModal.tsx
- [ ] حذف CreatePurchaseReturnModal.tsx
- [ ] إزالة الاستيرادات من SalesPage.tsx
- [ ] إزالة الاستيرادات من PurchasesPage.tsx
- [ ] إزالة الاستيرادات من SalesReturnsView.tsx
- [ ] إزالة الاستيرادات من PurchaseReturnsView.tsx

### المرحلة 2: إنشاء المكونات الجديدة
- [ ] إنشاء ReturnsWizard.tsx
- [ ] إنشاء InvoiceSelector.tsx
- [ ] إنشاء InvoiceItemsList.tsx
- [ ] إنشاء ReturnSummary.tsx

### المرحلة 3: التكامل
- [ ] تحديث SalesPage.tsx
- [ ] تحديث PurchasesPage.tsx
- [ ] اختبار التكامل

---

## الاعتبارات التقنية

### استخدام React Hook Form بشكل صحيح
```typescript
// الطريقة الصحيحة
const { register, handleSubmit, setValue, watch } = useForm();

<input {...register('fieldName')} />

// مع استخدام setValue في onChange
<input 
  {...register('search')}
  onChange={(e) => {
    register('search').onChange(e);
    setLocalState(e.target.value);
  }}
/>
```

### إدارة الحالة
- استخدام useState للحالات المحلية
- استخدام useMemo للعمليات الحسابية
- تجنب استخدام setState داخل useEffect بدون مصفوفة تبعيات

### إدارة z-index
- التأكد من أن القوائم المنسدلة تظهر فوق باقي العناصر
- استخدام z-50 أو أعلى للقوائم

---

## ملخص الوظائف

عند اختيار الفاتورة الأصلية (سواء مبيعات أو مشتريات):
1. يتم جلب جميع أصناف الفاتورة
2. يتم عرضها في قائمة واضحة
3. يمكن للمستخدم تحديد الكمية المراد إرجاعها لكل صنف
4. يتم التحقق تلقائياً من الكميات
5. عند التأكد يتم:
   - إنشاء مرتجع مرتبط بالفاتورة الأصلية
   - تحديث المخزون تلقائياً
