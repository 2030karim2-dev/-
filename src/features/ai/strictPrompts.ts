/**
 * ØªØ¹Ù„ÙŠÙ…Ø§Øª ØµØ§Ø±Ù…Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙ„ÙÙŠÙ‚ ÙˆØ§Ù„ÙƒØ°Ø¨
 * ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„ÙƒÙ„ prompt ÙŠÙØ±Ø³Ù„ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙÙŠ Ø¹Ù‚Ù„ Ø§Ù„Ø¬Ø¹ÙØ±ÙŠ
 */

export const STRICT_DATA_RULES = `
### â›” Ù‚ÙˆØ§Ø¹Ø¯ ØµØ§Ø±Ù…Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¬Ø§ÙˆØ²Ù‡Ø§:
1. Ø§Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù„Ùƒ â€” Ù„Ø§ ØªØ®ØªÙ„Ù‚ Ø£ÙŠ Ø±Ù‚Ù… Ø£Ùˆ Ù†Ø³Ø¨Ø© Ø£Ùˆ Ø§Ø³Ù…
2. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… = 0 Ø£Ùˆ ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ù‚Ù„ Ø¨ÙˆØ¶ÙˆØ­ "Ù„Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¤Ø´Ø±"
3. Ù„Ø§ ØªØªÙˆÙ‚Ø¹ Ø£Ø±Ù‚Ø§Ù… Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ© â€” Ù„Ø§ ØªÙ‚Ù„ "Ù…ØªÙˆÙ‚Ø¹ Ø²ÙŠØ§Ø¯Ø© 20%" Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‚Ø¯Ù…ØªÙ‡Ø§
4. Ù„Ø§ ØªØ¬Ø§Ù…Ù„ â€” Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ Ø³ÙŠØ¦Ø§Ù‹ Ù‚Ù„ Ø°Ù„Ùƒ Ø¨ØµØ±Ø§Ø­Ø© Ù…Ø¹ Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­
5. Ù„Ø§ ØªØ°ÙƒØ± Ø£ÙŠ Ø§Ø³Ù… Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ù…ÙˆØ±Ø¯ Ø£Ùˆ Ù…Ù†ØªØ¬ Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø°ÙÙƒØ± ØµØ±Ø§Ø­Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
6. ÙƒÙ„ Ø±Ù‚Ù… ØªØ°ÙƒØ±Ù‡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø£Ø®ÙˆØ°Ø§Ù‹ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…" Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
8. Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø© "Ø­Ø³Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…" Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ù„Ø£ÙŠ Ø±Ù‚Ù…

### ðŸ”¥ Ù‚ÙˆØ§Ø¹Ø¯ ØµØ§Ø±Ù…Ø© Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (ACTIONS):
- Ù„Ø§ ØªÙ‚Ù… Ø¨ØªÙ†ÙÙŠØ° Ø£ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø§Ù„ÙŠØ© (Ù…ØµØ±ÙˆÙØŒ Ø³Ù†Ø¯ØŒ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ØŒ ÙˆØºÙŠØ±Ù‡Ø§) Ø¥Ù„Ø§ Ø¥Ø°Ø§ ØªØ£ÙƒØ¯Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
- Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ†ÙÙŠØ° Ø£Ù…Ø± ÙˆØ§Ø®ØªÙØª Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§ØªØŒ Ø§Ø³Ø£Ù„Ù‡ Ø¨Ù„Ø·Ù Ù„ØªÙƒÙ…Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
- Ø¹Ù†Ø¯Ù…Ø§ ØªÙ†ÙØ° Ø¥Ø¬Ø±Ø§Ø¡Ù‹ØŒ Ù„Ø§ ØªÙ‚Ù„ "Ø³Ø£Ù‚ÙˆÙ… Ø¨Ù€..." Ø¨Ù„ Ù†ÙØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¥Ø±Ø¬Ø§Ø¹ [ACTION]
- Ø¹Ù†Ø¯ ØªÙ†ÙÙŠØ° Ø¨Ø­Ø«ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠ Ø¨Ù„Ø§ ØªØ¹Ø¯ÙŠÙ„
`;

export const STRICT_SYSTEM_ROLE = `Ø£Ù†Øª Ù…Ø­Ù„Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ù‚ÙŠÙ‚. ÙˆØ¸ÙŠÙØªÙƒ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù„Ùƒ ÙÙ‚Ø·.
- Ù„Ø§ ØªØ®ØªÙ„Ù‚ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª
- Ù„Ø§ ØªØ¬Ø§Ù…Ù„ â€” ÙƒÙ† ØµØ±ÙŠØ­Ø§Ù‹ ÙˆØµØ§Ø¯Ù‚Ø§Ù‹
- Ø¥Ø°Ø§ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ¦Ø© Ù‚Ù„Ù‡Ø§ Ø¨ÙˆØ¶ÙˆØ­
- ÙƒÙ„ Ø±Ù‚Ù… ØªØ°ÙƒØ±Ù‡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø·
- Ø§ÙÙ‡Ù… Ø§Ù„Ø³ÙŠØ§Ù‚ Ø¬ÙŠØ¯Ø§Ù‹: Ù…ÙŠØ² Ø¨ÙŠÙ† "Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±" ÙˆØ¨ÙŠÙ† "Ø·Ù„Ø¨ Ø§Ù„ØªÙ†ÙÙŠØ°"
- Ù„Ø§ ØªÙ†ÙØ° Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø°Ù Ø£Ø¨Ø¯Ø§Ù‹ Ø­ØªÙ‰ Ù„Ùˆ Ø·ÙÙ„Ø¨Øª
- Ø±Ø¯ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·ØŒ ÙˆØ¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ± Ø¬Ø¯Ø§Ù‹ ÙˆÙˆØ¯ÙŠ
- Ø§Ø³ØªØ®Ø¯Ù… Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙˆØ§Ø­Ø¯ Ù…Ù†Ø§Ø³Ø¨ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©`;

/**
 * ÙŠØ¨Ù†ÙŠ Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† ÙƒØ§Ø¦Ù† businessData
 */
export function buildRealDataContext(data: any): string {
    const lines: string[] = [
        '=== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙŠØ© (Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©) ==='
    ];

    // Revenue & Expenses
    if (data.revenue > 0) {
        lines.push(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: ${fmt(data.revenue)}`);
    } else {
        lines.push('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ø³Ø¬Ù„Ø©');
    }

    if (data.expenses > 0) {
        lines.push(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${fmt(data.expenses)}`);
    } else {
        lines.push('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø©');
    }

    lines.push(`ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©: ${fmt(data.netProfit)} (${data.netProfit >= 0 ? 'Ø±Ø¨Ø­' : 'Ø®Ø³Ø§Ø±Ø©'})`);
    lines.push(`Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­: ${data.margin.toFixed(1)}%`);

    // Debts
    if (data.receivables > 0) {
        lines.push(`Ø¯ÙŠÙˆÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ù…Ø¨Ø§Ù„Øº Ù„Ùƒ): ${fmt(data.receivables)}`);
    } else {
        lines.push('Ø¯ÙŠÙˆÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡');
    }

    if (data.payables > 0) {
        lines.push(`Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ø¹Ù„ÙŠÙƒ): ${fmt(data.payables)}`);
    } else {
        lines.push('Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª');
    }

    // Liquidity
    lines.push(`Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©: ${fmt(data.liquidity)}`);

    // Inventory
    lines.push(`Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ: ${data.totalProducts || 0}`);
    lines.push(`Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶: ${data.lowStockCount || 0}`);

    // Revenue details
    if (data.revenues?.length > 0) {
        lines.push('\nØªÙØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:');
        data.revenues.slice(0, 8).forEach((r: any) => {
            lines.push(`  - ${r.name}: ${fmt(r.netBalance)}`);
        });
    }

    // Expense details
    if (data.expenses_list?.length > 0) {
        lines.push('\nØªÙØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:');
        data.expenses_list.slice(0, 8).forEach((e: any) => {
            lines.push(`  - ${e.name}: ${fmt(e.netBalance)}`);
        });
    }

    // Debtors
    if (data.debtors?.length > 0) {
        lines.push('\nØ£ÙƒØ¨Ø± Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠÙ†:');
        data.debtors.slice(0, 5).forEach((d: any) => {
            lines.push(`  - ${d.name}: ${fmt(d.balance)}`);
        });
    }

    lines.push('\n=== Ù†Ù‡Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ===');
    return lines.join('\n');
}

function fmt(val: number): string {
    if (val === 0 || val === undefined || val === null) return '0';
    return new Intl.NumberFormat('ar-SA', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(val);
}
